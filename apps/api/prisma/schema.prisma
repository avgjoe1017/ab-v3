generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id        String   @id @default(uuid())
  email     String   @unique
  struggle  String?  // Optional: what user is working on (e.g., "I'm dealing with imposter syndrome")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  preferences Preferences?
  sessions     Session[]
  entitlementState EntitlementState?
  entitlementEvents EntitlementEvent[]
  values         UserValue[]
}

model Preferences {
  userId       String @id
  schemaVersion Int
  json         String

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())
}

model Session {
  id        String   @id @default(uuid())
  ownerUserId String?
  source    String   // "catalog" | "user" | "generated"
  title     String
  goalTag   String?
  durationSec Int?
  voiceId   String
  pace      String?
  affirmationSpacingMs Int?
  affirmationsHash String
  frequencyHz Float?  // Binaural beat frequency in Hz (e.g., 10.0 for Alpha)
  brainwaveState String? // "Delta" | "Theta" | "Alpha" | "SMR" | "Beta"
  solfeggioHz Float?  // Solfeggio frequency in Hz (e.g., 528.0) - alternative to binaural

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  ownerUser User? @relation(fields: [ownerUserId], references: [id], onDelete: SetNull)

  affirmations SessionAffirmation[]
  audio        SessionAudio?

  @@index([ownerUserId])
  @@index([source])
  @@index([affirmationsHash])
}

model SessionAffirmation {
  id        String @id @default(uuid())
  sessionId String
  idx       Int
  text      String
  moderationStatus String @default("pending") // "pending" | "approved" | "flagged" | "rejected"
  moderationReason String? // Reason for flag/reject (e.g., "vulgar", "negative", "racist")
  moderatedBy String? // Admin user ID who moderated
  moderatedAt DateTime?
  originalText String? // Store original if edited
  autoFlagged Boolean @default(false) // True if flagged by automated moderation

  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)

  @@unique([sessionId, idx])
  @@index([sessionId])
  @@index([moderationStatus])
  @@index([sessionId, moderationStatus])
}

model AudioAsset {
  id        String   @id @default(uuid())
  kind      String   // "affirmationMerged" | "affirmationChunk" | "silence" | "background" | "binaural"
  hash      String
  url       String
  metaJson  String?
  createdAt DateTime @default(now())

  @@index([kind])
  sessionAudios SessionAudio[]
  sessionAudioAssets SessionAudioAsset[]
  @@unique([kind, hash])
}

model SessionAudio {
  sessionId String @id
  mergedAudioAssetId String
  generatedAt DateTime @default(now())

  session Session @relation(fields: [sessionId], references: [id], onDelete: Cascade)
  mergedAudioAsset AudioAsset @relation(fields: [mergedAudioAssetId], references: [id])
  assets SessionAudioAsset[]

  @@index([mergedAudioAssetId])
}

model SessionAudioAsset {
  id        String   @id @default(uuid())
  sessionId String
  kind      String   // "affirmation_line" | "affirmation_stitched" | "background" | "binaural" | "mix_preview" | "final_mix"
  lineIndex Int?     // For affirmation_line, the index of the affirmation
  storageKey String  // S3 key or local file path
  audioAssetId String? // Link to AudioAsset if cached
  durationMs Int?
  codec     String?  // "aac", "mp3", etc.
  sampleRate Int?     // e.g., 44100
  channels  Int?      // 1 = mono, 2 = stereo
  fileSize  Int?      // bytes
  checksum  String?   // SHA-256 hash
  createdAt DateTime @default(now())

  session SessionAudio @relation(fields: [sessionId], references: [sessionId], onDelete: Cascade)
  audioAsset AudioAsset? @relation(fields: [audioAssetId], references: [id], onDelete: SetNull)

  @@index([sessionId])
  @@index([sessionId, kind])
  @@index([sessionId, kind, lineIndex])
}

model EntitlementState {
  userId   String @id
  plan     String
  status   String
  renewsAt DateTime?
  source   String?
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
}

model EntitlementEvent {
  id        String   @id @default(uuid())
  userId    String
  provider  String
  type      String
  payloadJson String
  occurredAt DateTime @default(now())

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId, occurredAt])
}

model Job {
  id        String   @id @default(uuid())
  type      String   // "ensure-audio"
  status    String   // "pending", "processing", "completed", "failed"
  payload   String   // JSON
  result    String?  // JSON
  error     String?
  attempts  Int      @default(0)
  startedAt DateTime?
  finishedAt DateTime?
  sessionId String?  // Optional link to session
  userId    String?  // Optional link to user
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([type])
  @@index([createdAt])
  @@index([sessionId])
  @@index([userId])
}

model UserValue {
  id        String   @id @default(uuid())
  userId    String
  valueId   String   // Value identifier (e.g., "achievement", "connection")
  valueText String   // Display text (e.g., "Achievement & Success")
  rank      Int?     // Ranking (1 = highest priority, null = unranked)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([userId, rank])
}

model AdminUser {
  id        String   @id @default(uuid())
  email     String   @unique
  passwordHash String // bcrypt hash
  role      String   // "ADMIN" | "OPERATOR" | "SUPPORT" | "READ_ONLY"
  name      String?
  isActive  Boolean  @default(true)
  lastLoginAt DateTime?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  auditLogs AuditLog[]

  @@index([email])
  @@index([role])
}

model AuditLog {
  id        String   @id @default(uuid())
  adminUserId String
  action    String   // e.g., "session.delete", "user.update", "job.retry"
  resourceType String // e.g., "Session", "User", "Job"
  resourceId String?
  details   String?  // JSON string with before/after or additional context
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  adminUser AdminUser @relation(fields: [adminUserId], references: [id], onDelete: Cascade)

  @@index([adminUserId])
  @@index([action])
  @@index([resourceType, resourceId])
  @@index([createdAt])
}

model AISourceVersion {
  id              String   @id @default(uuid())
  promptTemplateId String
  version         Int      // Incrementing version number
  name            String
  content         String   // The prompt template content
  model           String?  // e.g., "gpt-4", "gpt-3.5-turbo"
  voice           String?  // For TTS prompts
  cachingPolicy   String?  // "enabled" | "disabled"
  rolloutPercent  Int      @default(0) // 0-100, percentage of traffic
  isActive        Boolean  @default(false)
  isTest          Boolean  @default(false) // Test versions don't affect production
  createdBy       String?  // Admin user ID
  createdAt       DateTime @default(now())
  activatedAt     DateTime?

  promptTemplate AISourcePromptTemplate @relation(fields: [promptTemplateId], references: [id], onDelete: Cascade)

  @@unique([promptTemplateId, version])
  @@index([promptTemplateId])
  @@index([promptTemplateId, isActive])
  @@index([createdAt])
}

model AISourcePromptTemplate {
  id        String   @id @default(uuid())
  name      String   @unique // e.g., "affirmation_generator", "session_title"
  description String?
  currentVersion Int @default(1)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  versions AISourceVersion[]

  @@index([name])
}
